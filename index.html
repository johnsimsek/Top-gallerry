<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Inky Vibes Compact Gallery</title>
<style>
*{box-sizing:border-box}
html,body{margin:0;background:#0d0d0d;color:#eaeaea;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}

:root{ --h: 420px; }
@media (max-width:520px){ :root{ --h: 360px; } }

.wrap{max-width:1100px;margin:0 auto;padding:12px}
.shell{border:1px solid rgba(255,255,255,.10);border-radius:16px;overflow:hidden;background:#000}

.top{
  height:44px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:1px solid rgba(255,255,255,.06);
}
.title{font-size:12px;letter-spacing:.18em;color:#cfcfcf;text-transform:uppercase}
.count{font-size:12px;letter-spacing:.18em;color:#9a9a9a}

.stage{
  position:relative;height:var(--h);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.stage::before{
  content:"";position:absolute; inset:0;
  background-image: var(--bg);
  background-size:cover;background-position:center;
  filter: blur(18px);transform: scale(1.1);opacity:.28;
}
.stage::after{
  content:"";position:absolute; inset:0;
  background: radial-gradient(transparent 0%, rgba(0,0,0,.35) 60%, rgba(0,0,0,.70) 100%);
}
.main{
  position:relative; z-index:2;
  width:100%; height:100%;
  object-fit:contain;
  opacity:0; transition:opacity .35s ease;
}
.main.show{opacity:1}

.nav{
  position:absolute; z-index:3;
  top:50%; transform:translateY(-50%);
  width:44px; height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:#fff;font-size:24px;cursor:pointer;
}
.nav.left{left:10px}
.nav.right{right:10px}
@media (max-width:520px){ .nav{display:none} }

.thumbs{
  display:flex;gap:8px;padding:10px;overflow-x:auto;
  border-top:1px solid rgba(255,255,255,.06);background:#0b0b0b;
}
.thumb{
  width:56px;height:42px;flex:0 0 auto;border-radius:10px;overflow:hidden;
  border:1px solid rgba(255,255,255,.12);
  opacity:.55;cursor:pointer;
}
.thumb.active{opacity:1;border-color:#9a9a9a}
.thumb img{width:100%;height:100%;object-fit:cover}

.lb{
  position:fixed; inset:0;
  background:rgba(0,0,0,.94);
  display:none; align-items:center; justify-content:center;
  z-index:9999;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.lb.show{display:flex}

.lbStage{
  position:relative;
  width:100vw; height:100vh;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.lbStage::before{
  content:""; position:absolute; inset:0;
  background-image: var(--lbbg);
  background-size:cover;background-position:center;
  filter: blur(22px); transform: scale(1.12);
  opacity:.22;
}
.lbStage::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(transparent 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,.80) 100%);
}

.lbImg{
  position:relative; z-index:2;
  width:100vw; height:100vh;
  object-fit:contain;
  -webkit-user-select:none; user-select:none;
  -webkit-touch-callout:none;
}

.lbBtn{
  position:absolute; z-index:3;
  width:44px;height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.20);
  background:rgba(255,255,255,.08);
  color:#fff;font-size:24px;cursor:pointer;
  display:grid;place-items:center;
}
.lbClose{
  top:calc(14px + env(safe-area-inset-top));
  right:calc(14px + env(safe-area-inset-right));
}
.lbPlay{
  top:calc(14px + env(safe-area-inset-top));
  left:calc(14px + env(safe-area-inset-left));
  font-size:18px;
}
.lbNav{ top:50%; transform:translateY(-50%); }
.lbPrev{ left:calc(14px + env(safe-area-inset-left)); }
.lbNext{ right:calc(14px + env(safe-area-inset-right)); }

.lbCount{
  position:absolute; z-index:3;
  bottom:calc(16px + env(safe-area-inset-bottom));
  left:50%; transform:translateX(-50%);
  font-size:12px; letter-spacing:.18em;
  color:#d6d6d6;
  padding:8px 12px;border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
@media (prefers-reduced-motion: reduce){ .main{transition:none} }
</style>
</head>
<body>

<div class="wrap">
  <div class="shell">
    <div class="top">
      <div class="title">Inky Vibes Tattoo</div>
      <div class="count" id="count">—</div>
    </div>

    <div class="stage" id="stage">
      <button class="nav left" id="prev" aria-label="Önceki">‹</button>
      <img class="main" id="main" src="" alt="" loading="eager" decoding="async">
      <button class="nav right" id="next" aria-label="Sonraki">›</button>
    </div>

    <div class="thumbs" id="thumbs"></div>
  </div>
</div>

<div class="lb" id="lb" aria-hidden="true">
  <div class="lbStage" id="lbStage">
    <img class="lbImg" id="lbImg" src="" alt="" draggable="false">
    <button class="lbBtn lbClose" id="lbClose" aria-label="Kapat">✕</button>
    <button class="lbBtn lbPlay" id="lbPlay" aria-label="Slayt">⏸</button>
    <button class="lbBtn lbNav lbPrev" id="lbPrev" aria-label="Önceki">‹</button>
    <button class="lbBtn lbNav lbNext" id="lbNext" aria-label="Sonraki">›</button>
    <div class="lbCount" id="lbCount">—</div>
  </div>
</div>

<script>
  /**
   * ✅ İstediğin sistem:
   * - Foto isimleri 01.jpg, 02.jpg, 03.jpg ... (SIRALI)
   * - 05.jpg eklersen: sayfayı yenilemeden otomatik ekler (polling)
   * - Silersen: özellikle sondan silince otomatik kaldırır
   * - 200 boş alan / siyah kare yok
   */
  const CONFIG = {
    ext: "jpg",
    probeMax: 500,
    slideMs: 2500,

    // ✅ otomatik güncelleme
    watchIntervalMs: 4000,      // 4 sn'de bir "yeni foto var mı" bakar
    reconcileIntervalMs: 30000, // 30 sn'de bir "silinmiş mi" kontrolü yapar

    imageTimeoutMs: 1800,
  };

  let IMAGES = [];
  let idx = 0;
  let slideTimer = null;

  const stage = document.getElementById('stage');
  const main  = document.getElementById('main');
  const count = document.getElementById('count');
  const thumbs= document.getElementById('thumbs');

  const lb = document.getElementById('lb');
  const lbStage = document.getElementById('lbStage');
  const lbImg = document.getElementById('lbImg');
  const lbClose = document.getElementById('lbClose');
  const lbPrev = document.getElementById('lbPrev');
  const lbNext = document.getElementById('lbNext');
  const lbPlay = document.getElementById('lbPlay');
  const lbCount = document.getElementById('lbCount');

  function pad2(n){ return String(n).padStart(2, "0"); }
  function fileFor(i){ return `${pad2(i)}.${CONFIG.ext}`; }

  function setBg(el, varName, src){
    el.style.setProperty(varName, `url("${src}")`);
  }

  function stopSlideshow(){
    if (slideTimer) clearInterval(slideTimer);
    slideTimer = null;
    lbPlay.textContent = "▶";
  }

  function startSlideshow(){
    stopSlideshow();
    lbPlay.textContent = "⏸";
    slideTimer = setInterval(next, CONFIG.slideMs);
  }

  function toggleSlideshow(){
    if (slideTimer) stopSlideshow();
    else startSlideshow();
  }

  function safeIndex(i){
    const n = IMAGES.length;
    if (n === 0) return 0;
    return (i % n + n) % n;
  }

  function buildThumbs(){
    thumbs.innerHTML = "";
    IMAGES.forEach((src,i)=>{
      const t = document.createElement('div');
      t.className = 'thumb';
      t.innerHTML = `<img src="${src}" alt="" loading="lazy" decoding="async">`;
      t.onclick = ()=>{ idx=i; render(); };
      thumbs.appendChild(t);
    });
  }

  function render(){
    if (IMAGES.length === 0){
      count.textContent = "0 / 0";
      main.classList.remove('show');
      main.removeAttribute("src");
      stage.style.setProperty('--bg', 'none');
      return;
    }

    idx = safeIndex(idx);
    main.classList.remove('show');

    const src = IMAGES[idx];
    setBg(stage, '--bg', src);
    count.textContent = `${idx+1} / ${IMAGES.length}`;

    document.querySelectorAll('.thumb').forEach((t,i)=>{
      t.classList.toggle('active', i===idx);
    });

    main.onload = ()=> main.classList.add('show');
    main.src = src;

    if (lb.classList.contains('show')){
      setBg(lbStage, '--lbbg', src);
      lbImg.src = src;
      lbCount.textContent = `${idx+1} / ${IMAGES.length}`;
    }
  }

  function next(){ idx = safeIndex(idx+1); render(); }
  function prev(){ idx = safeIndex(idx-1); render(); }

  document.getElementById('next').onclick = next;
  document.getElementById('prev').onclick = prev;

  function openLightbox(){
    if (IMAGES.length === 0) return;
    const src = IMAGES[idx];

    lb.classList.add('show');
    lb.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = "hidden";

    setBg(lbStage, '--lbbg', src);
    lbImg.src = src;
    lbCount.textContent = `${idx+1} / ${IMAGES.length}`;

    startSlideshow();
  }

  function closeLightbox(){
    lb.classList.remove('show');
    lb.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = "";
    stopSlideshow();
    lbImg.src = "";
  }

  main.onclick = openLightbox;

  lbClose.onclick = closeLightbox;
  lbPrev.onclick = ()=>{ prev(); startSlideshow(); };
  lbNext.onclick = ()=>{ next(); startSlideshow(); };
  lbPlay.onclick = toggleSlideshow;

  lbImg.addEventListener('click', (e)=>{ e.stopPropagation(); }, {passive:true});
  lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLightbox(); });

  document.addEventListener('keydown', (e)=>{
    if (!lb.classList.contains('show')) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowRight") { next(); startSlideshow(); }
    if (e.key === "ArrowLeft") { prev(); startSlideshow(); }
    if (e.key === " ") { e.preventDefault(); toggleSlideshow(); }
  });

  function addSwipe(el, onLeft, onRight){
    let sx=0, sy=0;
    el.addEventListener('touchstart', (e)=>{
      const t = e.touches[0];
      sx = t.clientX; sy = t.clientY;
    }, {passive:true});

    el.addEventListener('touchend', (e)=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - sx;
      const dy = t.clientY - sy;
      if(Math.abs(dx) > 45 && Math.abs(dx) > Math.abs(dy)){
        if(dx < 0) onLeft(); else onRight();
      }
    }, {passive:true});
  }

  addSwipe(stage, next, prev);
  addSwipe(lbStage, ()=>{ next(); startSlideshow(); }, ()=>{ prev(); startSlideshow(); });

  function isRealImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      const timer = setTimeout(()=>finish(false), CONFIG.imageTimeoutMs);

      function finish(ok){
        clearTimeout(timer);
        img.onload = null;
        img.onerror = null;
        resolve(ok);
      }

      img.onload = ()=>finish(true);
      img.onerror = ()=>finish(false);

      const bust = `cb=${Date.now()}_${Math.random().toString(16).slice(2)}`;
      img.src = url.includes("?") ? `${url}&${bust}` : `${url}?${bust}`;
    });
  }

  async function probeInitialSequential(){
    const found = [];
    for (let i = 1; i <= CONFIG.probeMax; i++){
      const f = fileFor(i);
      if (await isRealImage(f)) found.push(f);
      else break; // ✅ ilk eksikte dur
    }
    return found;
  }

  async function watchForNewImages(){
    // ✅ sadece "sonraki" dosyayı kontrol eder → hızlı
    let nextIndex = IMAGES.length + 1;
    if (nextIndex < 1) nextIndex = 1;

    for (let guard = 0; guard < 10; guard++){
      const f = fileFor(nextIndex);
      const ok = await isRealImage(f);
      if (!ok) break;

      IMAGES.push(f);
      nextIndex++;

      buildThumbs();
      render();
    }
  }

  async function reconcileDeletionsFromEnd(){
    // ✅ sadece sondan kontrol eder (01..04 varken 04 silinirse düşer)
    while (IMAGES.length > 0){
      const last = IMAGES[IMAGES.length - 1];
      const ok = await isRealImage(last);
      if (ok) break;

      IMAGES.pop();
      idx = Math.min(idx, Math.max(0, IMAGES.length - 1));
      buildThumbs();
      render();
    }
  }

  async function init(){
    IMAGES = await probeInitialSequential();
    buildThumbs();
    idx = 0;
    render();

    // ✅ otomatik update
    setInterval(watchForNewImages, CONFIG.watchIntervalMs);
    setInterval(reconcileDeletionsFromEnd, CONFIG.reconcileIntervalMs);
  }

  init();
</script>
</body>
</html>